<!doctype html>
<html>
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
        <meta name="description" content="" />

        <title>hackertrends</title>

        <link href="/css/screen.css" rel="stylesheet"  type="text/css" media="screen, projection"/>
        <link href='http://fonts.googleapis.com/css?family=Allerta' rel='stylesheet' type='text/css'>
    </head>
    <body>
        <div id="nav">
            hackertrends
            <a id="tab-post-graphs" class="tab selected" href="#post-graphs">Post Graphs</a>
            <a id="tab-post-table" class="tab" href="#post-table">Post Table</a>
            
            <button id="refresh">REFRESH</button> <span id="post-count"></span>
        </div>
        <div id="post-graphs-box" class="box">
            <h2>Count vs Rank</h2>
            <div id="countvsrank" class="graph"></div>
        
            <h2>Time In Top 30 vs Rank</h2>
            <div id="top30vsrank" class="graph"></div>

            <h2># Comments vs Rank</h2>
            <div id="commentsvsrank" class="graph"></div>
            
            <h2># Comments vs Time In Top 30</h2>
            <div id="commentsvstop30" class="graph"></div>
        </div>
        <div id="post-table-box" class="box">
            <h2>Posts by Rank</h2>
            <table>
            </table>
        </div>
        
        <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.4.4/jquery.min.js"></script>
        <script type="text/javascript" src="/js/jquery.flot.min.js"></script>
        
        <script type="text/javascript">
            var ht_url = "/get-posts/";
            var showing = "post-graphs";
            
            function showPostGraphs () {
                $(".box").hide();
                $("#post-graphs-box").show();
                showing = "post-graphs";
                updatePostGraphs()
            }
            
            function showPostTable () {
                $(".box").hide();
                $("#post-table-box").show();
                showing = "post-table";
                updatePostTable();
            }
            
            
            
            function updatePostGraphs () {
                $("#post-graphs-box .graph").empty();
                var countvsrank = [];
                var top30vsrank = [];
                var commentsvsrank = [];
                var commentsvstop30 = [];
                
                //prime countvsrank
                for(var i = 1; i <= 30; i++) { countvsrank.push([i,0]); }
                
                for(var i = 0; i < data.length; i++) {
                    countvsrank[data[i].rank - 1][1] = countvsrank[data[i].rank - 1][1] + 1;
                    
                    var time_in_top_30 = Math.floor(((new Date(data[i].updated_at)).getTime()-(new Date(data[i].added_at)).getTime())/(1000*60*60));
                    top30vsrank.push([data[i].rank, time_in_top_30]);
                    
                    commentsvsrank.push([data[i].rank, data[i].num_comments]);
                    
                    commentsvstop30.push([time_in_top_30, data[i].num_comments]);
                }
                $.plot($("#countvsrank"), [countvsrank], {
                    series: {
                        bars: { show: true }
                    },
                    grid: {
                        tickColor: "#eee"
                    }
                });
                $.plot($("#top30vsrank"), [top30vsrank], {
                    series: {
                        points: { show: true }
                    },
                    xaxis: {
                        ticks: 30,
                        min: 0,
                        max: 30
                    },
                    grid: {
                        tickColor: "#eee"
                    }
                });
                $.plot($("#commentsvsrank"), [commentsvsrank], {
                    series: {
                        points: { show: true }
                    },
                    xaxis: {
                        ticks: 30,
                        min: 0,
                        max: 30
                    },
                    grid: {
                        tickColor: "#eee"
                    }
                });
                $.plot($("#commentsvstop30"), [commentsvstop30], {
                    series: {
                        points: { show: true }
                    },
                    grid: {
                        tickColor: "#eee"
                    }
                });
            }
            
            function updatePostTable () {
                $("#post-table-box table").empty();
                
                var append_html = '<tr><th class="number">#</th><th class="title">title</th><th class="rank">max rank</th><th class="rank">score</th><th class="rank">#&nbsp;comments</th><th class="age">age</th><th class="last-seen">last seen</th></tr>';
                
                var current_rank = 0;
                var odd_even = 'odd';
                for(var i = 0; i < data.length; i++) {

                    var age = Math.floor(((new Date()).getTime()-(new Date(data[i].age)).getTime())/(1000*60*60));
                    var last_seen = Math.floor(((new Date()).getTime()-(new Date(data[i].updated_at)).getTime())/(1000*60*60));

                    if (current_rank != data[i].rank) {
                        if(odd_even === 'odd') {
                            odd_even = 'even';
                        } else {
                            odd_even = 'odd';
                        }
                        current_rank = data[i].rank;
                    }
                    
                    append_html += '<tr class="data-row ' + odd_even +'" title="posted by ' + data[i].user + '">';
                    append_html += '<td class="number">' + (i + 1).toString() + '</td>';
                    append_html += '<td class="title"><a href="http://news.ycombinator.com/item?id='+ data[i].hn_id.toString() +'">' + data[i].title_text +' &raquo;</a></td>';
                    append_html += '<td class="rank">' + data[i].rank +'</td>';
                    append_html += '<td class="rank">' + data[i].score +'</td>';
                    append_html += '<td class="rank">' + data[i].num_comments +'</td>';
                    append_html += '<td class="age">' + age +' <span>hours</span></td>';
                    append_html += '<td class="age">' + last_seen +' <span>hours</span></td>';
                    append_html += '</tr>';
                }
                $("#post-table-box table").append(append_html);
            }
            
            function refreshData () {
                var q = { "rank": 30 }
                                
                $.getJSON(ht_url, q, function (response) {
                    if(response) {
                        data = response;
                        $("#post-count").text(response.length + ' posts');
                        if(showing === "post-graphs") {
                            updatePostGraphs();
                        } else if (showing === "post-table") {
                            updatePostTable();
                        }
                    }
                });
            }

            var data = [];
            var showing_graphs = true;

            $("button#refresh").click( refreshData );
            $("a#tab-post-graphs").click( showPostGraphs );
            $("a#tab-post-table").click( showPostTable );
            $(".tab").each( function () {
                var self = $(this);
                self.click( function () {
                    $(".selected").removeClass("selected");
                    self.addClass("selected");
                });
            });
            //$(document).ready( refreshData );
            
            $(document).ready( function () {
                refreshData();
                $("a#tab-" + window.location.hash.substring(1)).click();
            });
            
        </script>
        
    </body>
</html>